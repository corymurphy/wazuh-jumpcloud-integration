name: release

on:
  push:
    branches: ["main"]

permissions:
  contents: write

concurrency:
  group: release-main
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      APP_NAME: wazuh-jumpcloud-integration
      INITIAL_VERSION: v0.1.0

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: get version
        id: version
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          tags="$(gh release list --limit 200 --json tagName --jq '.[].tagName' 2>/dev/null || true)"
          latest="$(printf "%s\n" "${tags}" \
            | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' || true)"

          if [[ -z "${latest}" ]]; then
            next="${INITIAL_VERSION}"
          else
            latest_sorted="$(printf "%s\n" "${latest}" | sed 's/^v//' | sort -V | tail -n1)"
            IFS='.' read -r major minor patch <<< "${latest_sorted}"
            patch=$((patch + 1))
            next="v${major}.${minor}.${patch}"
          fi

          echo "tag=${next}" >> "$GITHUB_OUTPUT"

      - name: build
        shell: bash
        env:
          TAG: ${{ steps.version.outputs.tag }}
        run: |
          set -euo pipefail
          mkdir -p dist
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -trimpath -ldflags "-s -w" -o "dist/${APP_NAME}_${TAG}_linux_amd64" ./cmd/service
          (cd dist && sha256sum "${APP_NAME}_${TAG}_linux_amd64" > "${APP_NAME}_${TAG}_linux_amd64.sha256")

      - name: create release
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.version.outputs.tag }}
        run: |
          set -euo pipefail
          gh release create "${TAG}" dist/* --generate-notes --target "${GITHUB_SHA}"
